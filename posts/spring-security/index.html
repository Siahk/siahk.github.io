<!doctype html><html lang=en><head>
<meta name=generator content="Hugo 0.88.1">
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta property="og:title" content="Spring Security">
<meta name=keywords content="hugo,vitae,theme,static,blog"><meta name=description content="概述  Spring 是一个非常流行和成功的 Java 应用开发框架 Spring Security 基于 Spring 框架，提供了一套 Web 应用安全性的完整解决方案  相关：
 用户认证  设置用户名和密码  通过数据库完成认证   自定义登录页面   用户授权  权限访 …"><meta property="og:title" content="Spring Security">
<meta property="og:description" content="概述  Spring 是一个非常流行和成功的 Java 应用开发框架 Spring Security 基于 Spring 框架，提供了一套 Web 应用安全性的完整解决方案  相关：
 用户认证  设置用户名和密码  通过数据库完成认证   自定义登录页面   用户授权  权限访问控制 角色访问控制 自定义错误页面 用户注销 自动登录 CSRF功能   注解使用  1 用户认证 1.1 设置用户和密码 1 通过配置文件 application.properties
server.security.user.name=root server.security.user.password=123456 2 通过配置类 SecurityConfig.java
@Configuration @EnableWebSecurity public class SecurityConfig extends WebSecurityConfigurerAdapter { // 认证  @Override protected void configure(AuthenticationManagerBuilder auth) throws Exception { PasswordEncoder passwordEncoder = new BCryptPasswordEncoder(); String password = passwordEncoder.">
<meta property="og:type" content="article">
<meta property="og:url" content="http://siahk.github.io/posts/spring-security/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-05-02T15:47:40+08:00">
<meta property="article:modified_time" content="2021-05-02T15:47:40+08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Spring Security">
<meta name=twitter:description content="概述  Spring 是一个非常流行和成功的 Java 应用开发框架 Spring Security 基于 Spring 框架，提供了一套 Web 应用安全性的完整解决方案  相关：
 用户认证  设置用户名和密码  通过数据库完成认证   自定义登录页面   用户授权  权限访问控制 角色访问控制 自定义错误页面 用户注销 自动登录 CSRF功能   注解使用  1 用户认证 1.1 设置用户和密码 1 通过配置文件 application.properties
server.security.user.name=root server.security.user.password=123456 2 通过配置类 SecurityConfig.java
@Configuration @EnableWebSecurity public class SecurityConfig extends WebSecurityConfigurerAdapter { // 认证  @Override protected void configure(AuthenticationManagerBuilder auth) throws Exception { PasswordEncoder passwordEncoder = new BCryptPasswordEncoder(); String password = passwordEncoder.">
<link rel=stylesheet type=text/css media=screen href=/css/normalize.css>
<link rel=stylesheet type=text/css media=screen href=/css/main.css>
<link rel=stylesheet type=text/css media=screen href=/css/all.css>
<link rel=stylesheet href=/css/katex.min.css crossorigin=anonymous>
<script defer src=/js/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script>
<script defer src=/js/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script><title>Spring Security | Siahk'Blog</title>
</head>
<body><header>
<div id=titletext><h2 id=title><a href=http://siahk.github.io/>Siahk'Blog</a></h2></div>
<div id=title-description><p id=subtitle>Later equals never.</p><div id=social>
<nav>
<ul>
<li><a href=https://github.com/Siahk><i title=Github class="icons fab fa-github"></i></a></li>
<li><a href=/index.xml><i title=RSS class="icons fas fa-rss"></i></a></li></ul>
</nav>
</div>
</div>
<div id=mainmenu>
<nav>
<ul>
<li><a href=/>Home</a></li>
<li><a href=/posts>Blogs</a></li>
<li><a href=/about>About</a></li>
<li><a href=/tags>Tags</a></li>
<li><a href=/categories>Categories</a></li>
</ul>
</nav>
</div>
</header>
<main><div class=post>
<div class=author>
</div>
<div class=post-header>
<div class=meta>
<div class=date>
<span class=day>02</span>
<span class=rest>May 2021</span>
</div>
</div>
<div class=matter>
<h1 class=title>Spring Security</h1>
</div>
</div>
<div class=markdown>
<h1 id=概述>概述</h1>
<ul>
<li>Spring 是一个非常流行和成功的 Java 应用开发框架</li>
<li>Spring Security 基于 Spring 框架，提供了一套 Web 应用安全性的完整解决方案</li>
</ul>
<p><strong>相关：</strong></p>
<ul>
<li>用户认证
<ul>
<li>设置用户名和密码
<ul>
<li>通过数据库完成认证</li>
</ul>
</li>
<li>自定义登录页面</li>
</ul>
</li>
<li>用户授权
<ul>
<li>权限访问控制</li>
<li>角色访问控制</li>
<li>自定义错误页面</li>
<li>用户注销</li>
<li>自动登录</li>
<li>CSRF功能</li>
</ul>
</li>
<li>注解使用</li>
</ul>
<h1 id=1-用户认证>1 用户认证</h1>
<h2 id=11-设置用户和密码>1.1 设置用户和密码</h2>
<h3 id=1-通过配置文件>1 通过配置文件</h3>
<p>application.properties</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>server.security.user.name=root
server.security.user.password=123456
</code></pre></div><h3 id=2-通过配置类>2 通过配置类</h3>
<p>SecurityConfig.java</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#555;font-weight:700>@Configuration</span>
<span style=color:#555;font-weight:700>@EnableWebSecurity</span>
<span style=color:#080;font-weight:700>public</span> <span style=color:#080;font-weight:700>class</span> <span style=color:#b06;font-weight:700>SecurityConfig</span> <span style=color:#080;font-weight:700>extends</span> WebSecurityConfigurerAdapter <span style=color:#333>{</span>
    <span style=color:#888>// 认证
</span><span style=color:#888></span>    <span style=color:#555;font-weight:700>@Override</span>
    <span style=color:#080;font-weight:700>protected</span> <span style=color:#339;font-weight:700>void</span> <span style=color:#06b;font-weight:700>configure</span><span style=color:#333>(</span>AuthenticationManagerBuilder auth<span style=color:#333>)</span> <span style=color:#080;font-weight:700>throws</span> Exception <span style=color:#333>{</span>
        PasswordEncoder passwordEncoder <span style=color:#333>=</span> <span style=color:#080;font-weight:700>new</span> BCryptPasswordEncoder<span style=color:#333>();</span>
        String password <span style=color:#333>=</span> passwordEncoder<span style=color:#333>.</span><span style=color:#00c>encode</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;123456&#34;</span><span style=color:#333>);</span>
        auth<span style=color:#333>.</span><span style=color:#00c>inMemoryAuthentication</span><span style=color:#333>().</span><span style=color:#00c>withUser</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;root&#34;</span><span style=color:#333>).</span><span style=color:#00c>password</span><span style=color:#333>(</span>password<span style=color:#333>).</span><span style=color:#00c>roles</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;admin&#34;</span><span style=color:#333>);</span>
    <span style=color:#333>}</span>
    <span style=color:#555;font-weight:700>@Bean</span>
    PasswordEncoder <span style=color:#06b;font-weight:700>passwordEncoder</span><span style=color:#333>()</span> <span style=color:#333>{</span>
        <span style=color:#080;font-weight:700>return</span> <span style=color:#080;font-weight:700>new</span> BCryptPasswordEncoder<span style=color:#333>();</span>
    <span style=color:#333>}</span>
<span style=color:#333>}</span>
</code></pre></div><h3 id=3-自定义编写实现类>3 自定义编写实现类</h3>
<ol>
<li>
<p>创建配置类：设置使用哪个userDetailsService实现类</p>
<p>配置类名称：SecurityConfig.java依赖于<code>WebSecurityConfigurerAdapter</code></p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#555;font-weight:700>@Autowired</span>
<span style=color:#080;font-weight:700>private</span> UserDetailsService userDetailsService<span style=color:#333>;</span>
<span style=color:#555;font-weight:700>@Bean</span>
PasswordEncoder <span style=color:#06b;font-weight:700>passwordEncoder</span><span style=color:#333>()</span> <span style=color:#333>{</span>
    <span style=color:#080;font-weight:700>return</span> <span style=color:#080;font-weight:700>new</span> BCryptPasswordEncoder<span style=color:#333>();</span>
<span style=color:#333>}</span>
<span style=color:#888>// 认证 
</span><span style=color:#888></span><span style=color:#555;font-weight:700>@Override</span>
<span style=color:#080;font-weight:700>protected</span> <span style=color:#339;font-weight:700>void</span> <span style=color:#06b;font-weight:700>configure</span><span style=color:#333>(</span>AuthenticationManagerBuilder auth<span style=color:#333>)</span> <span style=color:#080;font-weight:700>throws</span> Exception <span style=color:#333>{</span>
    auth<span style=color:#333>.</span><span style=color:#00c>userDetailsService</span><span style=color:#333>(</span>userDetailsService<span style=color:#333>).</span><span style=color:#00c>passwordEncoder</span><span style=color:#333>(</span>passwordEncoder<span style=color:#333>());</span>
<span style=color:#333>}</span>
</code></pre></div></li>
<li>
<p>编写接口实现类，返回User对象，User对象包含用户名、密码和操作权限</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#555;font-weight:700>@Service</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;userDetailsService&#34;</span><span style=color:#333>)</span>
<span style=color:#080;font-weight:700>public</span> <span style=color:#080;font-weight:700>class</span> <span style=color:#b06;font-weight:700>MyUserDetailsService</span> <span style=color:#080;font-weight:700>implements</span> UserDetailsService <span style=color:#333>{</span>
    <span style=color:#555;font-weight:700>@Autowired</span>
    UserMapper userMapper<span style=color:#333>;</span> <span style=color:#888>// 注入UserMapper类
</span><span style=color:#888></span>    <span style=color:#555;font-weight:700>@Override</span>
    <span style=color:#080;font-weight:700>public</span> UserDetails <span style=color:#06b;font-weight:700>loadUserByUsername</span><span style=color:#333>(</span>String userName<span style=color:#333>)</span> <span style=color:#080;font-weight:700>throws</span> UsernameNotFoundException <span style=color:#333>{</span>
        User user <span style=color:#333>=</span> userMapper<span style=color:#333>.</span><span style=color:#00c>queryUserByName</span><span style=color:#333>(</span>userName<span style=color:#333>);</span> <span style=color:#888>// 调用UserMapper接口
</span><span style=color:#888></span>        List<span style=color:#333>&lt;</span>GrantedAuthority<span style=color:#333>&gt;</span> auths <span style=color:#333>=</span> AuthorityUtils<span style=color:#333>.</span><span style=color:#00c>commaSeparatedStringToAuthorityList</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;role&#34;</span><span style=color:#333>);</span> <span style=color:#888>// 权限 
</span><span style=color:#888></span>        <span style=color:#080;font-weight:700>return</span> <span style=color:#080;font-weight:700>new</span> org<span style=color:#333>.</span><span style=color:#00c>springframework</span><span style=color:#333>.</span><span style=color:#00c>security</span><span style=color:#333>.</span><span style=color:#00c>core</span><span style=color:#333>.</span><span style=color:#00c>userdetails</span><span style=color:#333>.</span><span style=color:#00c>User</span><span style=color:#333>(</span>user<span style=color:#333>.</span><span style=color:#00c>getName</span><span style=color:#333>(),</span>
                <span style=color:#080;font-weight:700>new</span> BCryptPasswordEncoder<span style=color:#333>().</span><span style=color:#00c>encode</span><span style=color:#333>(</span>user<span style=color:#333>.</span><span style=color:#00c>getPwd</span><span style=color:#333>()),</span>auths<span style=color:#333>);</span> <span style=color:#888>// 返回User对象
</span><span style=color:#888></span>    <span style=color:#333>}</span>
<span style=color:#333>}</span>
</code></pre></div><p><em>注：</em></p>
<p>①*@Service*：*此注解属于业务逻辑层，service或者manager层；默认按照名称进行装配，名称通过name属性指定，如果没有name属性，当注解写在字段上时，默认name为字段名进行查找，如果注解写在setter方法上，默认name为方法名进行装配。当找不到匹配的bean时，才按照类型进行装配，如果name名称一旦指定就会按照名称进行装配。*</p>
</li>
</ol>
<h2 id=12-自定义登录页面>1.2 自定义登录页面</h2>
<p>ServiceConfig.java</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#555;font-weight:700>@Override</span>
    <span style=color:#080;font-weight:700>protected</span> <span style=color:#339;font-weight:700>void</span> <span style=color:#06b;font-weight:700>configure</span><span style=color:#333>(</span>HttpSecurity http<span style=color:#333>)</span> <span style=color:#080;font-weight:700>throws</span> Exception <span style=color:#333>{</span>
        http<span style=color:#333>.</span><span style=color:#00c>formLogin</span><span style=color:#333>()</span> <span style=color:#888>// 自定义自己编写的登录页面
</span><span style=color:#888></span>                <span style=color:#333>.</span><span style=color:#00c>loginPage</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;/login.html&#34;</span><span style=color:#333>)</span> <span style=color:#888>// 登录页面设置
</span><span style=color:#888></span>                <span style=color:#333>.</span><span style=color:#00c>loginProcessingUrl</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;/login&#34;</span><span style=color:#333>)</span> <span style=color:#888>//设置访问路径
</span><span style=color:#888></span>                <span style=color:#333>.</span><span style=color:#00c>defaultSuccessUrl</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;/test&#34;</span><span style=color:#333>).</span><span style=color:#00c>permitAll</span><span style=color:#333>()</span> <span style=color:#888>// 登录成功之后，跳转路径
</span><span style=color:#888></span>                <span style=color:#333>.</span><span style=color:#00c>and</span><span style=color:#333>()</span>
                <span style=color:#333>.</span><span style=color:#00c>authorizeRequests</span><span style=color:#333>()</span> <span style=color:#888>// 授权请求
</span><span style=color:#888></span>                <span style=color:#333>.</span><span style=color:#00c>antMatchers</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;/&#34;</span><span style=color:#333>,</span><span style=background-color:#fff0f0>&#34;/index&#34;</span><span style=color:#333>).</span><span style=color:#00c>permitAll</span><span style=color:#333>()</span> <span style=color:#888>// 设置那些路径可以直接访问，不需要认证
</span><span style=color:#888></span>                <span style=color:#333>.</span><span style=color:#00c>anyRequest</span><span style=color:#333>().</span><span style=color:#00c>authenticated</span><span style=color:#333>();</span>
        http<span style=color:#333>.</span><span style=color:#00c>csrf</span><span style=color:#333>().</span><span style=color:#00c>disable</span><span style=color:#333>();</span> <span style=color:#888>// 关闭csrf功能
</span><span style=color:#888></span>    <span style=color:#333>}</span>
</code></pre></div><p>MvcConfig.java</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#555;font-weight:700>@Configuration</span>
<span style=color:#080;font-weight:700>public</span> <span style=color:#080;font-weight:700>class</span> <span style=color:#b06;font-weight:700>MvcConfig</span> <span style=color:#080;font-weight:700>implements</span> WebMvcConfigurer <span style=color:#333>{</span>
    <span style=color:#555;font-weight:700>@Override</span>
    <span style=color:#080;font-weight:700>public</span> <span style=color:#339;font-weight:700>void</span> <span style=color:#06b;font-weight:700>addViewControllers</span><span style=color:#333>(</span>ViewControllerRegistry registry<span style=color:#333>)</span> <span style=color:#333>{</span>
        registry<span style=color:#333>.</span><span style=color:#00c>addViewController</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;/login.html&#34;</span><span style=color:#333>).</span><span style=color:#00c>setViewName</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;login&#34;</span><span style=color:#333>);</span>
    <span style=color:#333>}</span>
<span style=color:#333>}</span>
</code></pre></div><p>login.html</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>&lt;<span style=color:#070>form</span> <span style=color:#00c>action</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;/login&#34;</span> <span style=color:#00c>method</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;post&#34;</span>&gt;
    &lt;<span style=color:#070>label</span>&gt;用户名：&lt;<span style=color:#070>input</span> <span style=color:#00c>type</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;text&#34;</span> <span style=color:#00c>name</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;username&#34;</span>/&gt;&lt;/<span style=color:#070>label</span>&gt;
    &lt;<span style=color:#070>br</span>&gt;
    &lt;<span style=color:#070>label</span>&gt;密码&lt;<span style=color:#070>input</span> <span style=color:#00c>type</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;text&#34;</span> <span style=color:#00c>name</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;password&#34;</span>/&gt;&lt;/<span style=color:#070>label</span>&gt;
    &lt;<span style=color:#070>br</span>&gt;
    &lt;<span style=color:#070>input</span> <span style=color:#00c>type</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;submit&#34;</span> <span style=color:#00c>th:value</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;login&#34;</span>/&gt;
&lt;/<span style=color:#070>form</span>&gt;
</code></pre></div><p><em>注：接收的是POST请求</em></p>
<h1 id=2-用户授权>2 用户授权</h1>
<h2 id=21-权限访问控制>2.1 权限访问控制</h2>
<h3 id=hasauthority设置单个权限>hasAuthority：设置单个权限</h3>
<p>设置权限：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#555;font-weight:700>@Override</span>
    <span style=color:#080;font-weight:700>protected</span> <span style=color:#339;font-weight:700>void</span> <span style=color:#06b;font-weight:700>configure</span><span style=color:#333>(</span>HttpSecurity http<span style=color:#333>)</span> <span style=color:#080;font-weight:700>throws</span> Exception <span style=color:#333>{</span>
        http<span style=color:#333>.</span><span style=color:#00c>authorizeRequests</span><span style=color:#333>().</span><span style=color:#00c>antMatchers</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;/&#34;</span><span style=color:#333>).</span><span style=color:#00c>hasAuthority</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;admin&#34;</span><span style=color:#333>);</span>
    <span style=color:#333>}</span>
</code></pre></div><p>获取权限：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#555;font-weight:700>@Override</span>    
    <span style=color:#080;font-weight:700>public</span> UserDetails <span style=color:#06b;font-weight:700>loadUserByUsername</span><span style=color:#333>(</span>String userName<span style=color:#333>)</span> <span style=color:#080;font-weight:700>throws</span> UsernameNotFoundException <span style=color:#333>{</span>
        List<span style=color:#333>&lt;</span>GrantedAuthority<span style=color:#333>&gt;</span> auths <span style=color:#333>=</span> AuthorityUtils<span style=color:#333>.</span><span style=color:#00c>commaSeparatedStringToAuthorityList</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;admin&#34;</span><span style=color:#333>);</span>
    <span style=color:#333>}</span>
</code></pre></div><h3 id=hasanyauthority设置多个权限>hasAnyAuthority：设置多个权限</h3>
<p>设置权限</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#555;font-weight:700>@Override</span>
    <span style=color:#080;font-weight:700>protected</span> <span style=color:#339;font-weight:700>void</span> <span style=color:#06b;font-weight:700>configure</span><span style=color:#333>(</span>HttpSecurity http<span style=color:#333>)</span> <span style=color:#080;font-weight:700>throws</span> Exception <span style=color:#333>{</span>
        http<span style=color:#333>.</span><span style=color:#00c>authorizeRequests</span><span style=color:#333>().</span><span style=color:#00c>antMatchers</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;/&#34;</span><span style=color:#333>).</span><span style=color:#00c>hasAnyAuthority</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;admin, guest&#34;</span><span style=color:#333>);</span>
    <span style=color:#333>}</span>
</code></pre></div><p>获取权限</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#555;font-weight:700>@Override</span>    
    <span style=color:#080;font-weight:700>public</span> UserDetails <span style=color:#06b;font-weight:700>loadUserByUsername</span><span style=color:#333>(</span>String userName<span style=color:#333>)</span> <span style=color:#080;font-weight:700>throws</span> UsernameNotFoundException <span style=color:#333>{</span>
        List<span style=color:#333>&lt;</span>GrantedAuthority<span style=color:#333>&gt;</span> auths <span style=color:#333>=</span> AuthorityUtils<span style=color:#333>.</span><span style=color:#00c>commaSeparatedStringToAuthorityList</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;admin&#34;</span><span style=color:#333>);</span>
    <span style=color:#333>}</span>
</code></pre></div><h2 id=22-角色访问控制>2.2 角色访问控制</h2>
<p>设置权限</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#888>// 单个角色
</span><span style=color:#888></span>http<span style=color:#333>.</span><span style=color:#00c>authorizeRequests</span><span style=color:#333>().</span><span style=color:#00c>antMatchers</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;/&#34;</span><span style=color:#333>).</span><span style=color:#00c>hasRole</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;sale&#34;</span><span style=color:#333>);</span>
<span style=color:#888>// 多个角色
</span><span style=color:#888></span>http<span style=color:#333>.</span><span style=color:#00c>authorizeRequests</span><span style=color:#333>().</span><span style=color:#00c>antMatchers</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;/&#34;</span><span style=color:#333>).</span><span style=color:#00c>hasAnyRole</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;sale, lucy&#34;</span><span style=color:#333>);</span>
</code></pre></div><p>获取权限</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#555;font-weight:700>@Override</span>    
    <span style=color:#080;font-weight:700>public</span> UserDetails <span style=color:#06b;font-weight:700>loadUserByUsername</span><span style=color:#333>(</span>String userName<span style=color:#333>)</span> <span style=color:#080;font-weight:700>throws</span> UsernameNotFoundException <span style=color:#333>{</span>
        List<span style=color:#333>&lt;</span>GrantedAuthority<span style=color:#333>&gt;</span> auths <span style=color:#333>=</span> AuthorityUtils<span style=color:#333>.</span><span style=color:#00c>commaSeparatedStringToAuthorityList</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;ROLE_sale&#34;</span><span style=color:#333>);</span>
    <span style=color:#333>}</span>
</code></pre></div><h2 id=23-自定义错误页面>2.3 自定义错误页面</h2>
<p>在resources目录下添加<code>error</code>文件夹，建立对应错误的名字的页面</p>
<p>例：403.html、404.html、500.html</p>
<h2 id=24-用户注销>2.4 用户注销</h2>
<ol>
<li>
<p>登录页面添加退出连接</p>
<p>index.html</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#333>&lt;</span>body<span style=color:#333>&gt;</span>
<span style=color:#333>&lt;</span>a href<span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;/logout&#34;</span><span style=color:#333>&gt;</span>logout<span style=color:#333>&lt;/</span>a<span style=color:#333>&gt;</span>
<span style=color:#333>&lt;/</span>body<span style=color:#333>&gt;</span>
</code></pre></div></li>
<li>
<p>配置类中添加映射地址</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>http<span style=color:#333>.</span><span style=color:#00c>logout</span><span style=color:#333>().</span><span style=color:#00c>logoutUrl</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;/logout&#34;</span><span style=color:#333>).</span><span style=color:#00c>logoutSuccessUrl</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;/index&#34;</span><span style=color:#333>).</span><span style=color:#00c>permitAll</span><span style=color:#333>();</span>
</code></pre></div></li>
</ol>
<h2 id=25-自动登录>2.5 自动登录</h2>
<ol>
<li>
<p>创建数据库表</p>
</li>
<li>
<p>注入数据源，配置操作数据库对象（在配置类中）</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#555;font-weight:700>@Autowired</span>
    DataSource dataSource<span style=color:#333>;</span>
    <span style=color:#888>// 配置对象
</span><span style=color:#888></span>    <span style=color:#555;font-weight:700>@Bean</span>
    <span style=color:#080;font-weight:700>public</span> PersistentTokenRepository <span style=color:#06b;font-weight:700>persistentTokenRepository</span><span style=color:#333>()</span> <span style=color:#333>{</span>
        JdbcTokenRepositoryImpl jdbcTokenRepository <span style=color:#333>=</span> <span style=color:#080;font-weight:700>new</span> JdbcTokenRepositoryImpl<span style=color:#333>();</span>
        jdbcTokenRepository<span style=color:#333>.</span><span style=color:#00c>setDataSource</span><span style=color:#333>(</span>dataSource<span style=color:#333>);</span>
<span style=color:#888>//        jdbcTokenRepository.setCreateTableOnStartup(true); // 自动创建数据库表
</span><span style=color:#888></span>        <span style=color:#080;font-weight:700>return</span> jdbcTokenRepository<span style=color:#333>;</span>
    <span style=color:#333>}</span>
</code></pre></div></li>
<li>
<p>修改配置类</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#888>// 授权
</span><span style=color:#888></span>    <span style=color:#555;font-weight:700>@Override</span>
    <span style=color:#080;font-weight:700>protected</span> <span style=color:#339;font-weight:700>void</span> <span style=color:#06b;font-weight:700>configure</span><span style=color:#333>(</span>HttpSecurity http<span style=color:#333>)</span> <span style=color:#080;font-weight:700>throws</span> Exception <span style=color:#333>{</span>
        http<span style=color:#333>.</span><span style=color:#00c>rememberMe</span><span style=color:#333>().</span><span style=color:#00c>tokenRepository</span><span style=color:#333>(</span>persistentTokenRepository<span style=color:#333>())</span> <span style=color:#888>// 设置操作对象
</span><span style=color:#888></span>                <span style=color:#333>.</span><span style=color:#00c>tokenValiditySeconds</span><span style=color:#333>(</span>60<span style=color:#333>)</span> <span style=color:#888>// 设置有效时长，单位秒
</span><span style=color:#888></span>                <span style=color:#333>.</span><span style=color:#00c>userDetailsService</span><span style=color:#333>(</span>userDetailsService<span style=color:#333>);</span> <span style=color:#888>// 设置查询的数据库对象
</span><span style=color:#888></span>    <span style=color:#333>}</span>
</code></pre></div></li>
</ol>
<h2 id=26-csrf功能>2.6 CSRF功能</h2>
<p><strong>跨站请求伪造</strong>（Cross-site request forgery）也称<strong>CSRF</strong>：实现的原理是CSRF攻击者在用户已经登录目标网站之后，诱使用户访问一个攻击页面，利用目标网站对用户的信任，以用户身份在攻击页面对目标网站发起伪造用户操作的请求，达到攻击目的。</p>
<p>默认开启CSRF保护，关闭方式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#888>// 配置类，授权方法里
</span><span style=color:#888></span>http<span style=color:#333>.</span><span style=color:#00c>csrf</span><span style=color:#333>().</span><span style=color:#00c>disable</span><span style=color:#333>();</span>
</code></pre></div><p>针对的<code>PATCH</code>，<code>POST</code>，<code>PUT</code>，<code>DELETE</code>方法进行防护</p>
<p>登录页面添加一个隐藏域：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>&lt;<span style=color:#070>input</span> <span style=color:#00c>type</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;hidden&#34;</span> <span style=color:#00c>th:if</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;${_csrf}!=null&#34;</span> <span style=color:#00c>th:href</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;${_csrf.token}&#34;</span> <span style=color:#00c>name</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;_csrf&#34;</span>&gt;
</code></pre></div><h1 id=3-注解>3 注解</h1>
<p>使用注解需要先开启注解功能</p>
<h2 id=31-secured>3.1 @Secured</h2>
<p><code>@EnableGlobalMethodSecurity(securedEnabled = true)</code></p>
<p>作用：判断是否有角色。需要注意匹配的字符串需要添加前缀"ROLE_"。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#888>// 控制器中使用
</span><span style=color:#888></span><span style=color:#555;font-weight:700>@Controller</span>
<span style=color:#080;font-weight:700>public</span> <span style=color:#080;font-weight:700>class</span> <span style=color:#b06;font-weight:700>UserController</span> <span style=color:#333>{</span>
    <span style=color:#555;font-weight:700>@GetMapping</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;/test&#34;</span><span style=color:#333>)</span>
    <span style=color:#555;font-weight:700>@Secured</span><span style=color:#333>({</span><span style=background-color:#fff0f0>&#34;ROLE_sale&#34;</span><span style=color:#333>,</span><span style=background-color:#fff0f0>&#34;ROLE_lucy&#34;</span><span style=color:#333>})</span> <span style=color:#888>// 需要sale或lucy角色才能使用该方法
</span><span style=color:#888></span>    <span style=color:#080;font-weight:700>public</span> String <span style=color:#06b;font-weight:700>test</span><span style=color:#333>()</span> <span style=color:#333>{</span>
        <span style=color:#080;font-weight:700>return</span> <span style=background-color:#fff0f0>&#34;/test&#34;</span><span style=color:#333>;</span>
    <span style=color:#333>}</span>
<span style=color:#333>}</span>
</code></pre></div><h2 id=32-preauthorize>3.2 @PreAuthorize</h2>
<p><code>@EnableGlobalMethodSecurity(prePostEnabled = true)</code></p>
<p>作用：适合于进入方法前的验证，可以将登录用户的<code>role</code>/<code>permissions</code>参数传到方法中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#888>// 控制器中使用
</span><span style=color:#888></span><span style=color:#555;font-weight:700>@Controller</span>
<span style=color:#080;font-weight:700>public</span> <span style=color:#080;font-weight:700>class</span> <span style=color:#b06;font-weight:700>UserController</span> <span style=color:#333>{</span>
    <span style=color:#555;font-weight:700>@GetMapping</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;/test&#34;</span><span style=color:#333>)</span>
    <span style=color:#888>// @PreAuthorize(&#34;hasRole(&#39;Role_管理员&#39;)&#34;)
</span><span style=color:#888></span>    <span style=color:#555;font-weight:700>@PreAuthorize</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;hasAnyAuthority(&#39;menu:system&#39;)&#34;</span><span style=color:#333>)</span>
    <span style=color:#080;font-weight:700>public</span> String <span style=color:#06b;font-weight:700>test</span><span style=color:#333>()</span> <span style=color:#333>{</span>
        <span style=color:#080;font-weight:700>return</span> <span style=background-color:#fff0f0>&#34;/test&#34;</span><span style=color:#333>;</span>
    <span style=color:#333>}</span>
<span style=color:#333>}</span>
</code></pre></div><h2 id=33-postauthorize>3.3 @PostAuthorize</h2>
<p><code>@EnableGlobalMethodSecurity(prePostEnabled = true)</code></p>
<p>作用：使用不多，在方法执行后再进行权限验证，适合验证带有返回值的权限。</p>
<h2 id=34-prefilter>3.4 @PreFilter</h2>
<p>作用：进入控制器之前对数据进行过滤</p>
<h2 id=35-postfilter>3.5 @PostFilter</h2>
<p>作用：权限验证之后对数据进行过滤，留下用户名是Admin的数据。</p>
<pre><code>@GetMapping(&quot;/test&quot;)
@PreAuthorize(&quot;hasRole('Role_管理员')&quot;)
@PostFilter(&quot;filterObject.username == 'Admin'&quot;)
</code></pre>
</div>
</div></div>
</main>
<footer>
© Copyright notice | <a href=https://github.com/dataCobra/hugo-vitae>Vitae</a> theme for <a href=https://gohugo.io>Hugo</a>
</footer>
</body>
</html>